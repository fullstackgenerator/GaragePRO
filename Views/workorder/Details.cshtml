@model GaragePRO.Models.WorkOrder

@{
    ViewBag.Title = "Work Order Details";
    Layout = "_Layout";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4>Work Order Details</h4>
    <div>
        <a class="btn btn-primary" asp-action="Edit" asp-route-id="@Model.Id">Edit</a>
        <form asp-action="DeleteConfirmed" asp-route-id="@Model.Id" method="post" style="display:inline;">
            <button type="submit" class="btn btn-danger">Delete</button>
            @Html.AntiForgeryToken()
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Work Order #@Model.Id</h5>
        <p class="card-text">
            <strong>Date In:</strong> @Model.DateIn.ToString("dd. mm. yyyy") <br />
            <strong>Date Out:</strong> @(Model.DateOut?.ToString("dd. mm. yyyy")) <br />
            <strong>Vehicle:</strong> @Model.Vehicle.Make @Model.Vehicle.Model <br />
            <strong>Mechanic:</strong> @Model.Mechanic.FullName <br />
            <strong>Status:</strong> @Model.Status.ToString() <br />
            <strong>Notes:</strong> @Model.Notes
        </p>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
    <h4>Service Detail</h4>
    <a asp-controller="ServiceDetail" asp-action="Create" asp-route-workOrderId="@Model.Id" class="btn btn-sm btn-success">
        + Add Service Detail
    </a>
</div>

@if (Model.ServiceDetails != null && Model.ServiceDetails.Any())
{
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Description</th>
            <th>Labor Hours</th>
            <th>Rate</th>
            <th>Total</th>
            <th>Created</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var detail in Model.ServiceDetails)
        {
            <tr>
                <td>@detail.Description</td>
                <td>@detail.LaborHours</td>
                <td>@detail.HourlyRate.ToString()€</td>
                <td>@(detail.LaborHours * detail.HourlyRate)€</td>
                <td>@detail.CreatedAt.ToShortDateString()</td>
                <td>
                    <div class="d-flex gap-2 align-items-center">
                        <a class="btn btn-primary btn-sm" asp-controller="ServiceDetail" asp-action="Edit" asp-route-id="@detail.Id">Edit</a>

                        <form asp-controller="ServiceDetail" asp-action="DeleteServiceDetailConfirmed" asp-route-id="@detail.Id" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            @Html.AntiForgeryToken()
                        </form>
                    </div>

                </td>
            </tr>
        }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-warning">No service details recorded yet.</div>
}

<div class="d-flex justify-content-between align-items-center mb-2">
    <h4>Parts Used</h4>
    <a asp-controller="PartUsed" asp-action="Create" asp-route-workOrderId="@Model.Id" class="btn btn-sm btn-success">
        + Add Part
    </a>
</div>

@if (Model.PartsUsed != null && Model.PartsUsed.Any())
{
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Part Name</th>
            <th>Part Price</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Date</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var part in Model.PartsUsed)
        {
            <tr>
                <td>@part.PartCatalog.PartName</td>
                <td>@part.PartCatalog.PartPrice</td>
                <td>@part.Quantity</td>
                <td>@(part.Quantity * part.PartCatalog.PartPrice)€</td>
                <td>@part.CreatedAt.ToShortDateString()</td>
                <td>
                    <div class="d-flex gap-2 align-items-center">
                        <a class="btn btn-primary btn-sm" asp-controller="PartUsed" asp-action="Edit" asp-route-id="@part.Id">Edit</a>

                        <form asp-controller="PartUsed" asp-action="Delete" asp-route-id="@part.Id" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            @Html.AntiForgeryToken()
                        </form>
                    </div>

                </td>
            </tr>
        }
    
    <tr>
        <td colspan="3" class="text-end"><strong>Total Parts Cost:</strong></td>
        <td colspan="3">
            <strong>
                @Model.PartsUsed.Sum(p => p.Quantity * p.PartCatalog.PartPrice)€
            </strong>
        </td>
    </tr>
    </tbody>
    </table>
}
else
{
    <div class="alert alert-info">No parts recorded for this work order.</div>
}
